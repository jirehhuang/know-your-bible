{% extends "base.html" %}

{% block title %}Result{% endblock %}

{% block styles %}
  <style>
    .result-container {
      text-align: center;
      font-family: sans-serif;
      margin-top: 100px;
    }
    .stars {
      font-size: 2em;
      color: gold;
      margin: 10px 0;
    }
    button {
      font-size: 1.0em;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="result-container">

    {% set submitted_book = submitted_ref.split()[0].lower() %}
    {% set submitted_chapter = submitted_ref.split()[1].split(":")[0] %}
    {% set submitted_verse = submitted_ref.split()[1].split(":")[1] %}

    {% set actual_book = actual_ref.split()[0].lower() %}
    {% set actual_chapter = actual_ref.split()[1].split(":")[0] %}
    {% set actual_verse = actual_ref.split()[1].split(":")[1] %}

    {% if submitted_book == actual_book and submitted_chapter == actual_chapter and submitted_verse == actual_verse %}
      {% set stars = 3 %}
    {% elif submitted_book == actual_book and submitted_chapter == actual_chapter %}
      {% set stars = 2 %}
    {% elif submitted_book == actual_book %}
      {% set stars = 1 %}
    {% else %}
      {% set stars = 0 %}
    {% endif %}

    {% set minutes = (timer // 60) | int %}
    {% set seconds = (timer % 60) | int %}
    {% set formatted_timer = "%02d:%02d"|format(minutes, seconds) %}

    <div class="stars">
      {% for i in range(stars) %}
        &#9733;
      {% endfor %}
      {% for i in range(3 - stars) %}
        &#9734;
      {% endfor %}
    </div>

    <table style="margin: 0 auto; border-collapse: separate; border-spacing: 0.5em 0.75em;">
      <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
      </colgroup>
      <tr>
        <td style="text-align: right; max-width: 20em; width: auto;"><strong>Score:</strong></td>
        <td style="text-align: left; max-width: 20em; width: auto;">{{ score }} / 100</td>
      </tr>
      <tr>
        <td style="text-align: right; max-width: 20em; width: auto;"><strong>Timer:</strong></td>
        <td style="text-align: left; max-width: 20em; width: auto;">{{ formatted_timer }}</td>
      </tr>
      <tr>
        <td style="text-align: right; max-width: 20em; width: auto;"><strong>Due In:</strong></td>
        <td style="text-align: left; max-width: 20em; width: auto;">{{ due_in }} ({{ rating }})</td>
      </tr>
      <tr>
        <td style="text-align: right; max-width: 20em; width: auto;"><strong>Your Answer:</strong></td>
        <td style="text-align: left; max-width: 20em; width: auto;">{{ submitted_ref }}</td>
      </tr>
      <tr>
        <td style="text-align: right; max-width: 20em; width: auto;"><strong>Reference:</strong></td>
        <td style="text-align: left; max-width: 20em; width: auto;">{{ actual_ref }}</td>
      </tr>
    </table>

    <br><br>
    <form action="/continue" method="post">
      <button id="continue-button" type="submit" autofocus>Continue</button>
    </form>
    <br><br>

    {% set label_col_width = '15em' %}
    {% set value_col_width = '30em' %}
    <table style="margin: 0 auto; border-collapse: separate; border-spacing: 1em 1em; margin-bottom: 2em">
      <tr>
        <td style="text-align: right; vertical-align: top; max-width: {{ label_col_width }}; width: auto;">{{ actual_ref }}</td>
        <td style="text-align: left; vertical-align: top; max-width: {{ value_col_width}}; width: auto;">{{ actual_text }}</td>
      </tr>
      <tr>
        <td style="text-align: right; vertical-align: top; max-width: {{ label_col_width }}; width: auto;"><strong>Chapter:</strong></td>
        <td style="text-align: left; vertical-align: top; max-width: {{ value_col_width}}; width: auto;">{{ actual_ch }}</td>
      </tr>
      {% if harmony_data %}
        {% for harmony_entry in harmony_data %}
          <tr>
            <td style="text-align: right; vertical-align: top; max-width: {{ label_col_width }}; width: auto;"><strong>Harmony:</strong></td>
            <td style="text-align: left; vertical-align: top; max-width: {{ value_col_width}}; width: auto;">
              <div style="margin-bottom: 0.5em;">
                <em>{{ harmony_entry.category or 'Category' }}: {{ harmony_entry.subject or 'Subject' }}</em>
              </div>
              {{ harmony_entry.references | join(", ") }}
            </td>
          </tr>
        {% endfor %}
      {% endif %}
      {% if tsk_data %}
        {% for tsk_entry in tsk_data %}
          <tr>
            <td style="text-align: right; vertical-align: top; max-width: {{ label_col_width }}; width: auto;"><strong>{{ tsk_entry.word }}:</strong></td>
            <td style="text-align: left; vertical-align: top; max-width: {{ value_col_width}}; width: auto;">{{ tsk_entry.references | join(", ") }}</td>
          </tr>
        {% endfor %}
      {% endif %}
    </table>

  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.addEventListener("load", () => {
      setTimeout(() => {
        const btn = document.getElementById("continue-button");
        if (btn) {
          btn.focus();
          btn.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }, 100);
    });
  </script>
{% endblock %}
