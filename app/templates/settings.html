{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block styles %}
  <style>
    .container {
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      padding: 20px;
    }
    .indent {
      margin-left: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <form method="post" action="/settings">
    <h1>Settings</h1>

    Click "Save" to apply your changes. Login with Google to save your settings and progress across sessions.

    <br><br>

    {% if "@" in user_id %}
      <!-- Show stats table and scatter plot -->
       <h3 style="margin-bottom: 0.5em;">{{ user_id }}</h3>

      <section style="margin-bottom: 2em;">
        <table style="font-size: 0.9em; color: #333; border-collapse: collapse;">
          <tr>
            <td style="padding-right: 1.5em;">Timestamp:</td>
            <td id="last-reviewed-time">{{ stats.date_time or '' }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;">Verses Reviewed:</td><td>{{ stats.verses_reviewed | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;">Total Score:</td><td>{{ stats.total_score | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;">Total Points:</td><td>{{ stats.total_points | int }}</td>
          </tr>
        </table>
      </section>

      {% if review_data %}
        <h3 style="margin-bottom: 0.5em;">Review Progress</h3>
        <div id="review-scatter" style="height: 400px;"></div>

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
          const reviewData = {{ review_data | tojson }};
          const trace = {
            x: reviewData.map(r => r.time),
            y: reviewData.map(r => r.distance),
            text: reviewData.map(r => r.verse),
            mode: 'markers',
            type: 'scatter',
            marker: {
              color: reviewData.map(r => r.retrievability),
              colorscale: [
                [0.0, 'rgb(220, 20, 60)'],   // Red
                [0.5, 'rgb(255, 215, 0)'],   // Yellow (Gold)
                [1.0, 'rgb(34, 139, 34)']    // Green
              ],
              cmin: 0,
              cmax: 1,
              colorbar: { title: 'Retrievability' },
              size: 8,
              opacity: 0.8,
            },
            hovertemplate:
              "<b>%{text}</b><br>" +
              "Time: %{x}s<br>" +
              "Distance: %{y}<br>" +
              "Retrievability: %{marker.color:.2f}<extra></extra>"
          };

          Plotly.newPlot('review-scatter', [trace], {
            margin: { t: 10 },
            xaxis: { title: 'Time (s)' },
            yaxis: { title: 'Distance' },
            responsive: true,
          });
        </script>
      {% endif %}
    {% endif %}

    <h3>Review Settings</h3>

    <label for="translation">Bible Translation:</label>
    <select name="translation" id="translation">
      {% for trans in avail_translations %}
        <option value="{{ trans }}"
          {% if trans == selected_translation %}selected{% endif %}>
          {{ trans | upper }}
        </option>
      {% endfor %}
    </select>

    <br><br>

    <label for="priority">Verse Priority:</label>
    <select name="priority" id="priority">
      <option value="uniform" {% if priority == "uniform" %}selected{% endif %}>Uniform</option>
      <option value="weighted" {% if priority == "weighted" %}selected{% endif %}>Weighted</option>
    </select>

    <br><br>
    
    <label for="selector">Selection Method:</label>
    <select name="selector" id="selector">
      <option value="random" {% if selector == "random" %}selected{% endif %}>Random</option>
      <option value="greedy" {% if selector == "greedy" %}selected{% endif %}>Greedy</option>
    </select>

    <p id="method-description" style="font-style: italic; color: #444; margin-top: 1.5em; margin-bottom: 2em;"></p>

    <h3>Review Selection</h3>

    <ul>
      <li>Select testaments, books, and/or chapters to review. If none are selected, defaults to the whole Bible.</li>
      <li>If a testament is selected, all of its books are included. Similarly, if a book is selected, all of its chapters are included. Otherwise, only selected chapters are included.</li>
    </ul>
    <br>

    <label>
      <input type="checkbox" name="selected_testaments" value="old"
        {% if "old" in selected_testaments %}checked{% endif %}>
      <strong>Old Testament</strong><br><br>
    </label>
    <div class="indent">
      {% for book in ot_books %}
        <label>
          <input type="checkbox" name="selected_books" value="{{ book }}"
            {% if book in selected_books %}checked{% endif %}>
          {{ book }}
        </label>
        {% if book in chapter_counts and chapter_counts[book] > 1 %}
          <div class="indent">
            {% for chapter in range(1, chapter_counts[book] + 1) %}
              <label>
                <input type="checkbox" name="selected_chapters"
                       value="{{ book }}|{{ chapter }}"
                       {% if book in selected_chapters and chapter in selected_chapters[book] %}checked{% endif %}>
                {{ chapter }}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <br>
        {% endif %}
        <br>
      {% endfor %}
    </div>

    <br>
    <label>
      <input type="checkbox" name="selected_testaments" value="new"
        {% if "new" in selected_testaments %}checked{% endif %}>
      <strong>New Testament</strong><br><br>
    </label>
    <div class="indent">
      {% for book in nt_books %}
        <label>
          <input type="checkbox" name="selected_books" value="{{ book }}"
            {% if book in selected_books %}checked{% endif %}>
          {{ book }}
        </label>
        {% if book in chapter_counts and chapter_counts[book] > 1 %}
          <div class="indent">
            {% for chapter in range(1, chapter_counts[book] + 1) %}
              <label>
                <input type="checkbox" name="selected_chapters"
                       value="{{ book }}|{{ chapter }}"
                       {% if book in selected_chapters and chapter in selected_chapters[book] %}checked{% endif %}>
                {{ chapter }}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <br>
        {% endif %}
        <br>
      {% endfor %}
    </div>

    <br>
    <button type="submit" style="font-size: 1em;">Save</button>
  </form>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const elem = document.getElementById("last-reviewed-time");
    if (!elem || !elem.textContent) return;

    try {
      const iso = elem.textContent.trim();
      const dt = new Date(iso);
      
      // Try local timezone first
      let options = {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      };
      
      // Format as YYYY-MM-DD HH:mm:ss
      const parts = new Intl.DateTimeFormat(undefined, options).formatToParts(dt);
      const date = `${parts.find(p => p.type === 'year').value}-${parts.find(p => p.type === 'month').value}-${parts.find(p => p.type === 'day').value}`;
      const time = `${parts.find(p => p.type === 'hour').value}:${parts.find(p => p.type === 'minute').value}:${parts.find(p => p.type === 'second').value}`;
      
      elem.textContent = `${date} ${time}`;
    } catch (e) {
      // If error or unknown timezone, fallback to Pacific Time
      try {
        const dt = new Date(elem.textContent.trim());
        const pacificTime = new Date(dt.toLocaleString("en-US", { timeZone: "America/Los_Angeles" }));
        elem.textContent = pacificTime.toISOString().slice(0, 19).replace("T", " ");
      } catch {
        // Fallback silently if formatting fails
      }
    }
  });
  </script>

  <script>
    const translationSelect = document.getElementById("translation");
    const prioritySelect = document.getElementById("priority");
    const selectorSelect = document.getElementById("selector");
    const description = document.getElementById("method-description");

    function updateDescription() {
      const translation = translationSelect.value.toUpperCase();
      const priority = prioritySelect.value;
      const selector = selectorSelect.value;

      let desc = `Using text from the ${translation} translation. `;

      if (selector === "random") {
        desc += "Randomly select verses from review selection with probability proportional to weight, ";
      } else if (selector === "greedy") {
        desc += "Select verses from review selection with the highest weight, ";
      }

      if (priority === "weighted") {
        desc += `with greater initial weight given to more commonly cited verses in <a href=https://www.gty.org/>gty.org</a> sermons and <a href=https://www.desiringgod.org/>desiringgod.org</a> resources. `;
      } else {
        desc += "with equal initial weight given to all verses. ";
      }

      desc += "Verse weights are scaled down when recently reviewed and inflated when past due."

      description.innerHTML = desc;
    }

    // Initialize and bind listeners
    translationSelect.addEventListener("change", updateDescription);
    prioritySelect.addEventListener("change", updateDescription);
    selectorSelect.addEventListener("change", updateDescription);

    // Call once on page load
    updateDescription();
  </script>
{% endblock %}
