{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block styles %}
  <style>
    .container {
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      padding: 20px;
    }
    .indent {
      margin-left: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <form method="post" action="/settings">
    <h1>Settings</h1>

    Click "Save" to apply your changes. Login with Google to save your settings and progress across sessions.

    <br><br>

    {% if "@" in user_id %}
      <!-- Show stats table and scatter plot -->
       <h3 style="margin-bottom: 0.5em;">{{ user_id }}</h3>

      <section style="margin-bottom: 1em;">
        <table style="border-collapse: separate; border-spacing: 0em 0.5em; margin-top: 1em; margin-bottom: 1em; margin-left: 1em;">
          <tr>
            <td style="padding-right: 1.5em;"><strong>Timestamp:</strong></td>
            <td id="last-reviewed-time">{{ stats.date_time or '' }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;"><strong>Verses Reviewed:</strong></td><td>{{ stats.verses_reviewed | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;"><strong>Total Stars:</strong></td><td>{{ stats.total_stars | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;"><strong>Total Score:</strong></td><td>{{ stats.total_score | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;"><strong>Total Points:</strong></td><td>{{ stats.total_points | int }}</td>
          </tr>
          <tr>
            <td style="padding-right: 1.5em;"><strong>Past 30 Days:</strong></td><td>{{ stats.points_30days | int }}</td>
          </tr>
        </table>
      </section>

      <div style="margin-left: 1em; margin-bottom: 2.5em;">
        <button type="button" id="reset-button" style="font-size: 1em;">Delete All Data</button>
      </div>

      {% if review_data %}
        <h3 style="margin-bottom: 0.5em;">Review Progress</h3>
        <div id="review-scatter" style="height: 400px;"></div>

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
          const reviewData = {{ review_data | tojson }};

          const rawTicks = [0, 1, 3, 7, 14, 30, 90, 180, 365];
          const maxDay = Math.max(...reviewData.map(r => Math.abs(r.due_in_days)));
          const filteredTicks = rawTicks.filter(v => v <= maxDay);

          const tickVals = filteredTicks.flatMap(v => [-v, v]); // symmetrical ticks
          const tickLabels = tickVals.map(v => v.toString());
          const transformedTicks = tickVals.map(v => Math.asinh(v));
          
          const retrievabilities = reviewData.map(r => r.retrievability);

          const minRet = Math.min(...retrievabilities);
          const maxRet = Math.max(...retrievabilities);
          const midRet = (minRet + maxRet) / 2;

          let markerOptions;

          if (minRet === maxRet) {
            // Fixed color scale fallback
            function getColorFromRetrievability(ret) {
              if (ret <= 0.5) {
                // interpolate red to yellow
                const t = ret / 0.5;
                return `rgb(${Math.round(220 + (255 - 220) * t)}, ${Math.round(20 + (215 - 20) * t)}, 60)`;
              } else {
                // interpolate yellow to green
                const t = (ret - 0.5) / 0.5;
                return `rgb(${Math.round(255 - (221 * t))}, ${Math.round(215 - (215 - 139) * t)}, 0)`;
              }
            }

            const fixedColor = getColorFromRetrievability(minRet);
            markerOptions = {
              color: fixedColor,
              size: 5,
              sizemode: 'diameter',
              sizemin: 5,
              opacity: 0.8
            };
          } else {
            markerOptions = {
              color: retrievabilities,
              colorscale: [
                [0, 'rgb(220, 20, 60)'],
                [(midRet - minRet) / (maxRet - minRet), 'rgb(255, 215, 0)'],
                [1, 'rgb(34, 139, 34)']
              ],
              cmin: minRet,
              cmax: maxRet,
              colorbar: { title: 'Retrievability' },
              size: 10,
              sizemode: 'diameter',
              opacity: 0.8
            };
          }

          const trace = {
            x: reviewData.map(r => Math.asinh(r.due_in_days)),
            y: reviewData.map(r => r.score),
            text: reviewData.map(r => r.verse),
            mode: 'markers',
            type: 'scatter',
            marker: markerOptions,
            customdata: reviewData.map((r, i) => [r.url, r.due_in_str, r.distance, r.time]),
            hovertemplate:
              "<b>%{text}</b><br>" +
              "Score: %{y}<br>" +
              "Distance: %{customdata[2]}<br>" +
              "Time: %{customdata[3]}<br>" +
              "Due In: %{customdata[1]}<br>" +
              (minRet === maxRet
                ? `Retrievability: ${minRet.toFixed(2)}<br>`
                : "Retrievability: %{marker.color:.2f}<br>") +
              "<extra></extra>"
          };

          Plotly.newPlot('review-scatter', [trace], {
            margin: { t: 10 },
            xaxis: {
              title: 'Days Until Due',
              tickvals: transformedTicks,
              ticktext: tickLabels,
              ticklen: 8,
              tickwidth: 1,
              tickcolor: 'white',
              automargin: true,
            },
            yaxis: {
              title: 'Score',
              ticklen: 8,
              tickwidth: 1,
              tickcolor: 'white',
              automargin: true,
            },
            shapes: [
              {
                type: 'rect',
                xref: 'paper',
                yref: 'paper',
                x0: 0,
                y0: 0,
                x1: 1,
                y1: 1,
                line: {
                  color: 'black',
                  width: 2
                },
                layer: 'above'
              }
            ],
            hovermode: 'closest',
            responsive: true,
          });

          document.getElementById('review-scatter').on('plotly_click', function(data) {
            const url = data.points[0].customdata[0];
            if (url) {
              window.open(url, '_blank');
            }
          });
        </script>
      {% endif %}
    {% endif %}

    <h3>Review Settings</h3>

    <label for="translation">Bible Translation:</label>
    <select name="translation" id="translation">
      {% for trans in avail_translations %}
        <option value="{{ trans }}"
          {% if trans == selected_translation %}selected{% endif %}>
          {{ trans | upper }}
        </option>
      {% endfor %}
    </select>

    <br><br>

    <label for="priority">Verse Priority:</label>
    <select name="priority" id="priority">
      <option value="uniform" {% if priority == "uniform" %}selected{% endif %}>Uniform</option>
      <option value="weighted" {% if priority == "weighted" %}selected{% endif %}>Weighted</option>
    </select>

    <br><br>
    
    <label for="selector">Selection Method:</label>
    <select name="selector" id="selector">
      <option value="random" {% if selector == "random" %}selected{% endif %}>Random</option>
      <option value="greedy" {% if selector == "greedy" %}selected{% endif %}>Greedy</option>
    </select>

    <p id="method-description" style="font-style: italic; margin-top: 1.5em; margin-bottom: 2em;"></p>

    <h3>Review Selection</h3>

    <label>
      <input type="checkbox" name="verse_selection" id="use_verse-selection"
        {% if verse_selection %}checked{% endif %}>
      <strong>Verse Selection</strong>
    </label>

    <div id="verse-selection-container" style="margin-top: 1em; display: {% if verse_selection %}block{% else %}none{% endif %};">
      <!-- <label for="verse-selection-text" style="font-weight: bold;">Verse List:</label> -->
      <textarea name="selected_verses" id="verse-selection-text" rows="8" style="width: 100%; resize: vertical;">{{ selected_verses or '' }}</textarea>
    </div>

    <script>
      const verseSelectionCheckbox = document.getElementById("use_verse-selection");
      const verseSelectionContainer = document.getElementById("verse-selection-container");

      verseSelectionCheckbox?.addEventListener("change", () => {
        verseSelectionContainer.style.display = verseSelectionCheckbox.checked ? "block" : "none";
      });
    </script>

    <br><br>

    <ul>
      <li>Select testaments, books, and/or chapters to review. If none are selected, defaults to the whole Bible.</li>
      <li>If a testament is selected, all of its books are included. Similarly, if a book is selected, all of its chapters are included. Otherwise, only selected chapters are included.</li>
    </ul>
    <br>

    <label>
      <input type="checkbox" name="selected_testaments" value="old"
        {% if "old" in selected_testaments %}checked{% endif %}>
      <strong>Old Testament</strong><br><br>
    </label>
    <div class="indent">
      {% for book in ot_books %}
        <label>
          <input type="checkbox" name="selected_books" value="{{ book }}"
            {% if book in selected_books %}checked{% endif %}>
          {{ book }}
        </label>
        {% if book in chapter_counts and chapter_counts[book] > 1 %}
          <div class="indent">
            {% for chapter in range(1, chapter_counts[book] + 1) %}
              <label>
                <input type="checkbox" name="selected_chapters"
                       value="{{ book }}|{{ chapter }}"
                       {% if book in selected_chapters and chapter in selected_chapters[book] %}checked{% endif %}>
                {{ chapter }}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <br>
        {% endif %}
        <br>
      {% endfor %}
    </div>

    <br>
    <label>
      <input type="checkbox" name="selected_testaments" value="new"
        {% if "new" in selected_testaments %}checked{% endif %}>
      <strong>New Testament</strong><br><br>
    </label>
    <div class="indent">
      {% for book in nt_books %}
        <label>
          <input type="checkbox" name="selected_books" value="{{ book }}"
            {% if book in selected_books %}checked{% endif %}>
          {{ book }}
        </label>
        {% if book in chapter_counts and chapter_counts[book] > 1 %}
          <div class="indent">
            {% for chapter in range(1, chapter_counts[book] + 1) %}
              <label>
                <input type="checkbox" name="selected_chapters"
                       value="{{ book }}|{{ chapter }}"
                       {% if book in selected_chapters and chapter in selected_chapters[book] %}checked{% endif %}>
                {{ chapter }}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <br>
        {% endif %}
        <br>
      {% endfor %}
    </div>

    <br>
    <button type="submit" style="font-size: 1em;">Save</button>
  </form>

  <div id="reset-modal" style="display: none; position: fixed; top: 0; left: 0; 
      width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.6); z-index: 1000;">
    <div style="background-color: var(--bg-color); color: var(--text-color); padding: 2em; max-width: 500px; margin: 10vh auto; border-radius: 10px; border: 1px solid var(--text-color);">
      <h3 style="margin-top: 0;">Confirm Data Deletion</h3>
      <p>This will permanently delete <strong>all</strong> of your review data and settings. This action cannot be undone.</p>
      <p>To confirm, type: <code>delete data for {{ user_id }}</code></p>
      <input type="text" id="confirm-input" style="width: 100%; padding: 0.5em; margin-bottom: 1em;" placeholder="Type exact phrase here" />
      <div style="display: flex; justify-content: flex-end; gap: 1em;">
        <button id="cancel-reset" type="button">Cancel</button>
        <form method="post" action="/delete_user_data" onsubmit="return checkDeleteConfirmation();">
          <input type="hidden" name="user_id" value="{{ user_id }}">
          <button id="confirm-reset" type="submit" style="color: white; background: red; padding: 0.5em 1em;">Confirm</button>
        </form>
      </div>
      <p id="warning-message" style="color: red; display: none; margin-top: 1em;">‚ùå Input does not match required confirmation text.</p>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const elem = document.getElementById("last-reviewed-time");
    if (!elem || !elem.textContent) return;

    try {
      const iso = elem.textContent.trim();
      const dt = new Date(iso);
      
      // Try local timezone first
      let options = {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      };
      
      // Format as YYYY-MM-DD HH:mm:ss
      const parts = new Intl.DateTimeFormat(undefined, options).formatToParts(dt);
      const date = `${parts.find(p => p.type === 'year').value}-${parts.find(p => p.type === 'month').value}-${parts.find(p => p.type === 'day').value}`;
      const time = `${parts.find(p => p.type === 'hour').value}:${parts.find(p => p.type === 'minute').value}:${parts.find(p => p.type === 'second').value}`;
      
      elem.textContent = `${date} ${time}`;
    } catch (e) {
      // If error or unknown timezone, fallback to Pacific Time
      try {
        const dt = new Date(elem.textContent.trim());
        const pacificTime = new Date(dt.toLocaleString("en-US", { timeZone: "America/Los_Angeles" }));
        elem.textContent = pacificTime.toISOString().slice(0, 19).replace("T", " ");
      } catch {
        // Fallback silently if formatting fails
      }
    }
  });
  </script>

  <script>
    const translationSelect = document.getElementById("translation");
    const prioritySelect = document.getElementById("priority");
    const selectorSelect = document.getElementById("selector");
    const description = document.getElementById("method-description");

    function updateDescription() {
      const translation = translationSelect.value.toUpperCase();
      const priority = prioritySelect.value;
      const selector = selectorSelect.value;

      let desc = `Using text from the ${translation} translation. `;

      if (selector === "random") {
        desc += "Randomly select verses from review selection with probability proportional to weight, ";
      } else if (selector === "greedy") {
        desc += "Select verses from review selection with the highest weight, ";
      }

      if (priority === "weighted") {
        desc += `with greater initial weight given to more commonly cited verses in <a href=https://www.gty.org/>gty.org</a> sermons and <a href=https://www.desiringgod.org/>desiringgod.org</a> resources. `;
      } else {
        desc += "with equal initial weight given to all verses. ";
      }

      desc += "Verse weights are scaled down when recently reviewed and inflated when past due."

      description.innerHTML = desc;
    }

    // Initialize and bind listeners
    translationSelect.addEventListener("change", updateDescription);
    prioritySelect.addEventListener("change", updateDescription);
    selectorSelect.addEventListener("change", updateDescription);

    // Call once on page load
    updateDescription();
  </script>

  <script>
    const resetBtn = document.getElementById("reset-button");
    const modal = document.getElementById("reset-modal");
    const cancelReset = document.getElementById("cancel-reset");
    const confirmInput = document.getElementById("confirm-input");
    const warning = document.getElementById("warning-message");

    resetBtn?.addEventListener("click", () => {
      modal.style.display = "block";
      confirmInput.value = "";
      warning.style.display = "none";
    });

    cancelReset?.addEventListener("click", () => {
      modal.style.display = "none";
    });

    function checkDeleteConfirmation() {
      const expected = "delete data for {{ user_id }}";
      if (confirmInput.value.trim() !== expected) {
        warning.style.display = "block";
        return false;
      }
      return true;
    }
  </script>
{% endblock %}
